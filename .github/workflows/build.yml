name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ë²„ì „ ë²ˆí˜¸ (ì˜ˆ: 1.1.0)'
        required: false

jobs:
  build:
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
        include:
          - os: macos-latest
            build-command: npm run build:mac
          - os: windows-latest
            build-command: npm run build:win
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check environment variables
        shell: bash
        run: |
          if [ -z "${{ secrets.MASTER_ADMIN_PASSWORD }}" ]; then
            echo "âš ï¸ MASTER_ADMIN_PASSWORDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
          else
            echo "âœ… MASTER_ADMIN_PASSWORDê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi
      
      # 1. config.bin íŒŒì¼ ìƒì„± ë‹¨ê³„ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
      - name: Generate config.bin
        shell: bash
        run: node inject-env.js
        env:
          MASTER_ADMIN_PASSWORD: ${{ secrets.MASTER_ADMIN_PASSWORD }}
      
      - name: Verify config.bin
        shell: bash
        run: |
          if [ -f "config.bin" ]; then
            echo "âœ… config.bin íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
            # íŒŒì¼ í¬ê¸° í™•ì¸ (í”Œë«í¼ë³„ë¡œ ë‹¤ë¥¸ ëª…ë ¹ì–´ ì‚¬ìš©)
            if command -v stat >/dev/null 2>&1; then
              if stat -c%s config.bin >/dev/null 2>&1; then
                echo "íŒŒì¼ í¬ê¸°: $(stat -c%s config.bin) bytes"
              elif stat -f%z config.bin >/dev/null 2>&1; then
                echo "íŒŒì¼ í¬ê¸°: $(stat -f%z config.bin) bytes"
              else
                echo "íŒŒì¼ í™•ì¸ë¨"
              fi
            else
              echo "íŒŒì¼ í™•ì¸ë¨"
            fi
          else
            echo "âŒ config.bin íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          fi



      # 2. ë¹Œë“œ ë° ê²Œì‹œ ì°¨ë‹¨ ê°•í™” ë‹¨ê³„ (PublishManager ì˜¤ë¥˜ í•´ê²°ì„ ìœ„í•œ ìˆ˜ì •)
      - name: Build app
        shell: bash
        run: |
          # ğŸš¨ ê²Œì‹œ ê´€ë ¨ í™˜ê²½ ë³€ìˆ˜ ì™„ì „ ì°¨ë‹¨ ë° í† í° ë¹„ìš°ê¸° (ì˜¤ë¥˜ í•´ê²° í•µì‹¬)
          unset GH_TOKEN GITHUB_TOKEN 2>/dev/null || true
          export GH_TOKEN=""
          export GITHUB_TOKEN=""
          export PUBLISH="never"                   # 'null' ëŒ€ì‹  'never' ëª…ì‹œ
          export ELECTRON_BUILDER_PUBLISH="never"  # 'null' ëŒ€ì‹  'never' ëª…ì‹œ
          
          # electron-builder ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì™„ì „ ì°¨ë‹¨
          export ELECTRON_BUILDER_CACHE=""
          export ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=false
          export ELECTRON_GET_USE_PROXY=false
          export ELECTRON_SKIP_BINARY_DOWNLOAD=1
          export ELECTRON_BUILDER_OFFLINE=true
          export NO_INSTALL=1
          
          # ğŸ” ë¹Œë“œ ì „ íŒŒì¼ ìµœì¢… í™•ì¸ (ë””ë²„ê¹…)
          echo "ğŸ“¦ ë¹Œë“œ ì „ íŒŒì¼ í™•ì¸:"
          ls -la config.bin || { echo "âš ï¸ config.bin íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"; exit 1; }
          
          echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘..."
          echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"

          # í”Œë«í¼ë³„ electron-builder ì§ì ‘ í˜¸ì¶œ
          if [ "${{ matrix.os }}" == "macos-latest" ]; then
            echo "macOS ë¹Œë“œ ì‹¤í–‰ ì¤‘..."
            # --publish=neverë¥¼ ì‚¬ìš©í•˜ì—¬ ê²Œì‹œ ì™„ë²½ ì°¨ë‹¨
            if npx electron-builder --mac --publish=never; then
              echo "âœ… macOS ë¹Œë“œ ì„±ê³µ"
            else
              echo "âŒ macOS ë¹Œë“œ ì‹¤íŒ¨"
              exit 1
            fi
          else
            echo "Windows ë¹Œë“œ ì‹¤í–‰ ì¤‘..."
            # --publish=neverë¥¼ ì‚¬ìš©í•˜ì—¬ ê²Œì‹œ ì™„ë²½ ì°¨ë‹¨
            if npx electron-builder --win --publish=never; then
              echo "âœ… Windows ë¹Œë“œ ì„±ê³µ"
            else
              BUILD_EXIT_CODE=$?
              echo "âŒ Windows ë¹Œë“œ ì‹¤íŒ¨ (exit code: $BUILD_EXIT_CODE)"
              echo "ì˜¤ë¥˜ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”."
              exit $BUILD_EXIT_CODE
            fi
          fi
          echo "âœ… ë¹Œë“œ ì™„ë£Œ"
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          # ì´ ë‹¨ê³„ì—ì„œëŠ” config.binì´ í•„ìš”í•˜ë¯€ë¡œ, MASTER_ADMIN_PASSWORDëŠ” ë¶ˆí•„ìš”í•¨
          # PUBLISH ê´€ë ¨ í™˜ê²½ ë³€ìˆ˜ëŠ” run: ë¸”ë¡ ìƒë‹¨ì—ì„œ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ ì¤‘ë³µ ì œê±°
          ELECTRON_BUILDER_OFFLINE: "true"
          CI: "true"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.os }}
          path: dist/
          retention-days: 30
