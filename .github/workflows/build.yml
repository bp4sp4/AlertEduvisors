name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Î≤ÑÏ†Ñ Î≤àÌò∏ (Ïòà: 1.1.0)'
        required: false

jobs:
  build:
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
        include:
          - os: macos-latest
            build-command: npm run build:mac
          - os: windows-latest
            build-command: npm run build:win
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check environment variables
        shell: bash
        run: |
          if [ -z "${{ secrets.MASTER_ADMIN_PASSWORD }}" ]; then
            echo "‚ö†Ô∏è MASTER_ADMIN_PASSWORDÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Í∏∞Î≥∏Í∞íÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§."
          else
            echo "‚úÖ MASTER_ADMIN_PASSWORDÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§."
          fi
      
      - name: Generate config.bin
        shell: bash
        run: node inject-env.js
        env:
          MASTER_ADMIN_PASSWORD: ${{ secrets.MASTER_ADMIN_PASSWORD }}
      
      - name: Verify config.bin
        shell: bash
        run: |
          if [ -f "config.bin" ]; then
            echo "‚úÖ config.bin ÌååÏùºÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§."
            # ÌååÏùº ÌÅ¨Í∏∞ ÌôïÏù∏ (ÌîåÎû´ÌèºÎ≥ÑÎ°ú Îã§Î•∏ Î™ÖÎ†πÏñ¥ ÏÇ¨Ïö©)
            if command -v stat >/dev/null 2>&1; then
              if stat -c%s config.bin >/dev/null 2>&1; then
                echo "ÌååÏùº ÌÅ¨Í∏∞: $(stat -c%s config.bin) bytes"
              elif stat -f%z config.bin >/dev/null 2>&1; then
                echo "ÌååÏùº ÌÅ¨Í∏∞: $(stat -f%z config.bin) bytes"
              else
                echo "ÌååÏùº ÌôïÏù∏Îê®"
              fi
            else
              echo "ÌååÏùº ÌôïÏù∏Îê®"
            fi
          else
            echo "‚ùå config.bin ÌååÏùºÏù¥ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!"
            exit 1
          fi
      
      - name: Build app
        shell: bash
        run: |
          # Î™®Îì† GitHub Í¥ÄÎ†® ÌôòÍ≤Ω Î≥ÄÏàò ÏôÑÏ†Ñ Ï†úÍ±∞
          unset GH_TOKEN GITHUB_TOKEN 2>/dev/null || true
          export GH_TOKEN=""
          export GITHUB_TOKEN=""
          export PUBLISH=never
          export ELECTRON_BUILDER_PUBLISH=never
          
          # electron-builder ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠ ÏôÑÏ†Ñ Ï∞®Îã®
          export ELECTRON_BUILDER_CACHE=""
          export ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=false
          export ELECTRON_GET_USE_PROXY=false
          export ELECTRON_SKIP_BINARY_DOWNLOAD=1
          
          # config.bin ÌååÏùº ÌôïÏù∏
          echo "üì¶ ÎπåÎìú Ï†Ñ ÌååÏùº ÌôïÏù∏:"
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            if [ -f "config.bin" ]; then
              echo "‚úÖ config.bin ÌååÏùº ÌôïÏù∏Îê®"
            else
              echo "‚ö†Ô∏è config.bin ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§"
              exit 1
            fi
          else
            ls -la config.bin || echo "‚ö†Ô∏è config.bin ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§"
          fi
          
          # ÌîåÎû´ÌèºÎ≥Ñ electron-builder ÏßÅÏ†ë Ìò∏Ï∂ú (npm run Ïä§ÌÅ¨Î¶ΩÌä∏ Ïö∞Ìöå)
          # --publish neverÎ•º Îëê Î≤à Î™ÖÏãúÌïòÏó¨ ÌôïÏã§Ìûà Ï∞®Îã®
          echo "üî® ÎπåÎìú ÏãúÏûë..."
          echo "ÌòÑÏû¨ ÎîîÎ†âÌÜ†Î¶¨: $(pwd)"
          echo "ÌïÑÏöîÌïú ÌååÏùº ÌôïÏù∏:"
          test -f "package.json" && echo "‚úÖ package.json" || echo "‚ùå package.json ÏóÜÏùå"
          test -f "config.bin" && echo "‚úÖ config.bin" || echo "‚ùå config.bin ÏóÜÏùå"
          test -f "main.js" && echo "‚úÖ main.js" || echo "‚ùå main.js ÏóÜÏùå"
          
          if [ "${{ matrix.os }}" == "macos-latest" ]; then
            echo "macOS ÎπåÎìú Ïã§Ìñâ Ï§ë..."
            if npx electron-builder --mac --publish never --config.nsis.oneClick=false; then
              echo "‚úÖ macOS ÎπåÎìú ÏÑ±Í≥µ"
            else
              echo "‚ùå macOS ÎπåÎìú Ïã§Ìå®"
              exit 1
            fi
          else
            echo "Windows ÎπåÎìú Ïã§Ìñâ Ï§ë..."
            # Windows ÎπåÎìú: ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠ ÏôÑÏ†Ñ Ï∞®Îã®
            # --publish neverÏôÄ Ìï®Íªò Î™ÖÏãúÏ†ÅÏúºÎ°ú ÏÑ§Ï†ïÌïòÏó¨ Î™®Îì† ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠ Ï∞®Îã®
            echo "electron-builder Î≤ÑÏ†Ñ ÌôïÏù∏:"
            npx electron-builder --version || true
            
            # Windows ÎπåÎìú Ïã§Ìñâ (ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠ ÏóÜÏù¥ Î°úÏª¨ Î¶¨ÏÜåÏä§Îßå ÏÇ¨Ïö©)
            if npx electron-builder --win --publish never 2>&1; then
              echo "‚úÖ Windows ÎπåÎìú ÏÑ±Í≥µ"
            else
              BUILD_EXIT_CODE=$?
              echo "‚ùå Windows ÎπåÎìú Ïã§Ìå® (exit code: $BUILD_EXIT_CODE)"
              echo "Ïò§Î•ò ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî."
              exit $BUILD_EXIT_CODE
            fi
          fi
          echo "‚úÖ ÎπåÎìú ÏôÑÎ£å"
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          MASTER_ADMIN_PASSWORD: ${{ secrets.MASTER_ADMIN_PASSWORD }}
          PUBLISH: never
          ELECTRON_BUILDER_PUBLISH: never
          ELECTRON_BUILDER_CACHE: ""
          ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: "false"
          ELECTRON_GET_USE_PROXY: "false"
          ELECTRON_SKIP_BINARY_DOWNLOAD: "1"
          GH_TOKEN: ""
          GITHUB_TOKEN: ""
          CI: "true"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.os }}
          path: dist/
          retention-days: 30